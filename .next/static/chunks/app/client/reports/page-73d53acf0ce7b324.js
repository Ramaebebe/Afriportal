(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[501],{44694:function(e,t,n){Promise.resolve().then(n.bind(n,84317))},84317:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return x},dynamic:function(){return h}});var i=n(57437),a=n(2265),r=n(47625),s=n(21156),l=n(54061),o=n(10891),c=n(53375),u=n(24457),d=n.n(u),m=n(26634);n(34868),n(23893);let h="force-dynamic",p=["Availability","Utilisation","Downtime","Maintenance","Tyres","Fuel","Finance","Risk","Other"],f=()=>{let e=[];for(let t=0;t<9;t++)for(let n=0;n<3;n++)e.push({section:p[t],title:"".concat(p[t]," KPI ").concat(n+1),value:Math.round(1e3*Math.random())/10,unit:t<2?"%":"R",delta:Math.round((Math.random()-.5)*20)/10,spark:Array.from({length:14},()=>Math.round(80+20*Math.random()))});return e},v=e=>{let t=[],n=new Date;for(let i of e)for(let e=0;e<40;e++){let a=new Date(n.getTime()-864e5*e);t.push({section:i.section,title:i.title,ts:a.toISOString(),ref:"".concat(i.section.slice(0,2).toUpperCase(),"-").concat(e+1001),description:"Txn for ".concat(i.title),amount:Math.round(1e4*Math.random())/100,entity:["COJ","SANParks","Mangaung"][e%3]})}return t};function x(){let e=(0,m.N)(),t=(0,a.useRef)(null),[u,h]=(0,a.useState)(!1),[x,g]=(0,a.useState)(f()),[N,b]=(0,a.useState)(v(x)),y=async()=>{if(e){h(!0);try{let{data:t}=await e.from("report_tiles").select("*");(null==t?void 0:t.length)&&g(t.map(e=>{var t,n;return{section:e.section,title:e.title,value:Number(null!==(t=e.value)&&void 0!==t?t:0),unit:null!==(n=e.unit)&&void 0!==n?n:void 0,delta:null!=e.delta?Number(e.delta):void 0,spark:Array.isArray(e.spark)?e.spark:"string"==typeof e.spark?e.spark.split(",").map(e=>Number(e.trim())):[]}}));let{data:n}=await e.from("report_transactions").select("*").order("ts",{ascending:!1}).limit(2e3);(null==n?void 0:n.length)&&b(n.map(e=>{var t,n,i;return{section:e.section,title:e.title,ts:e.ts,ref:null!==(t=e.ref)&&void 0!==t?t:void 0,description:null!==(n=e.description)&&void 0!==n?n:void 0,amount:null!=e.amount?Number(e.amount):void 0,entity:null!==(i=e.entity)&&void 0!==i?i:void 0}}))}finally{h(!1)}}};(0,a.useEffect)(()=>{y()},[]);let S=async t=>{let i=await Promise.all([n.e(425),n.e(919)]).then(n.bind(n,2093)),a=await t.arrayBuffer(),r=i.read(a,{type:"array"}),s=r.Sheets.Reports||r.Sheets[r.SheetNames[0]],l=i.utils.sheet_to_json(s,{defval:""}).map(e=>({section:String(e.section||e.Section||"Other"),title:String(e.title||e.Title||"Untitled"),value:Number(e.value||e.Value||0),unit:String(e.unit||e.Unit||""),delta:""!==e.delta?Number(e.delta):void 0,spark:"string"==typeof e.spark?e.spark.split(",").map(e=>Number(e.trim())).filter(e=>!Number.isNaN(e)):void 0})),o=r.Sheets.Transactions,c=[];if(o&&(c=i.utils.sheet_to_json(o,{defval:""}).map(e=>({section:String(e.section||e.Section||"Other"),title:String(e.title||e.Title||"Untitled"),ts:e.ts?new Date(e.ts).toISOString():new Date().toISOString(),ref:String(e.ref||e.Ref||""),description:String(e.description||e.Description||""),amount:""!==e.amount?Number(e.amount):void 0,entity:String(e.entity||e.Entity||"")}))),e)try{l.length&&await e.from("report_tiles").upsert(l.map(e=>{var t;return{...e,spark:null!==(t=e.spark)&&void 0!==t?t:[]}})),c.length&&await e.from("report_transactions").upsert(c)}catch(e){console.warn("Supabase upsert error:",e)}l.length&&g(l),c.length&&b(c)},_=async()=>{let e=await Promise.all([n.e(425),n.e(919)]).then(n.bind(n,2093)),t=x.map(e=>{var t,n,i;return{section:e.section,title:e.title,value:e.value,unit:null!==(t=e.unit)&&void 0!==t?t:"",delta:null!==(n=e.delta)&&void 0!==n?n:"",spark:(null!==(i=e.spark)&&void 0!==i?i:[]).join(",")}}),i=N.map(e=>{var t,n,i,a;return{section:e.section,title:e.title,ts:e.ts,ref:null!==(t=e.ref)&&void 0!==t?t:"",description:null!==(n=e.description)&&void 0!==n?n:"",amount:null!==(i=e.amount)&&void 0!==i?i:"",entity:null!==(a=e.entity)&&void 0!==a?a:""}}),a=e.utils.book_new();e.utils.book_append_sheet(a,e.utils.json_to_sheet(t),"Reports"),e.utils.book_append_sheet(a,e.utils.json_to_sheet(i),"Transactions"),e.writeFile(a,"Afrirent_Reports.xlsx")},j=async()=>{let e=t.current;if(!e)return;let n=(await d()(e,{scale:2})).toDataURL("image/png"),i=new c.ZP({orientation:"landscape",unit:"px",format:"a4"}),a=i.internal.pageSize.getWidth(),r=i.internal.pageSize.getHeight();i.addImage(n,"PNG",0,0,a,r),i.save("Afrirent_Reports.pdf")},w=(0,a.useMemo)(()=>{let e=new Map;x.forEach(t=>{e.has(t.section)||e.set(t.section,[]),e.get(t.section).push(t)});let t=[],n=new Set(p);for(let[i,a]of(p.forEach(n=>{e.has(n)&&t.push([n,e.get(n)])}),e))n.has(i)||t.push([i,a]);return t},[x]),k=(0,a.useMemo)(()=>{let e=new Map;for(let[t,n]of(N.forEach(t=>{let n="".concat(t.section,"|||").concat(t.title);e.has(n)||e.set(n,[]),e.get(n).push(t)}),e))n.sort((e,t)=>e.ts>t.ts?-1:1);return e},[N]),E=[{headerName:"Date",field:"ts",valueFormatter:e=>new Date(e.value).toLocaleDateString()},{headerName:"Ref",field:"ref"},{headerName:"Description",field:"description",flex:1},{headerName:"Amount",field:"amount",valueFormatter:e=>null!=e.value?"R ".concat(Number(e.value).toLocaleString()):""},{headerName:"Entity",field:"entity"}];return(0,i.jsxs)("main",{children:[(0,i.jsxs)("div",{className:"card p-5 mb-4 flex flex-wrap items-center gap-3",children:[(0,i.jsx)("h1",{className:"text-2xl font-semibold mr-auto",children:"Reports"}),(0,i.jsxs)("label",{className:"btn cursor-pointer",children:["Import Excel/CSV",(0,i.jsx)("input",{type:"file",className:"hidden",accept:".xlsx,.xls,.csv",onChange:e=>e.target.files&&S(e.target.files[0])})]}),(0,i.jsx)("button",{className:"btn",onClick:_,children:"Export Excel"}),(0,i.jsx)("button",{className:"btn",onClick:j,children:"Export PDF"}),(0,i.jsx)("button",{className:"navlink",onClick:y,disabled:u,children:u?"Refreshingâ€¦":"Refresh"})]}),(0,i.jsx)("div",{ref:t,className:"space-y-8",children:w.map(e=>{let[t,n]=e;return(0,i.jsxs)("section",{children:[(0,i.jsxs)("div",{className:"flex items-center gap-3 mb-3",children:[(0,i.jsx)("img",{src:"/brand/report_icon.png",className:"h-6 opacity-80",alt:""}),(0,i.jsx)("h2",{className:"text-xl font-semibold",children:t}),(0,i.jsx)("div",{className:"h-px flex-1 bg-white/10"})]}),(0,i.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-5",children:n.slice(0,3).map((e,t)=>{var n,a;let c="".concat(e.section,"|||").concat(e.title),u=(null!==(n=k.get(c))&&void 0!==n?n:[]).slice(0,20);return(0,i.jsxs)("div",{className:"card p-5 watermark",children:[(0,i.jsxs)("div",{className:"flex items-baseline justify-between mb-2",children:[(0,i.jsx)("div",{className:"text-sm text-white/70",children:e.title}),void 0!==e.delta&&(0,i.jsxs)("div",{className:e.delta>=0?"text-green-400 text-xs":"text-red-400 text-xs",children:[e.delta>=0?"+":"",e.delta]})]}),(0,i.jsxs)("div",{className:"text-2xl font-bold mb-2",children:["R"===e.unit?"R ":"",e.value.toLocaleString(),e.unit&&"R"!==e.unit?" ".concat(e.unit):""]}),(0,i.jsx)("div",{className:"h-24 mb-3",children:(0,i.jsx)(r.h,{width:"100%",height:"100%",children:(0,i.jsx)(s.w,{data:(null!==(a=e.spark)&&void 0!==a?a:[]).map((e,t)=>({i:t,v:e})),children:(0,i.jsx)(l.x,{type:"monotone",dataKey:"v",stroke:"#EC6425",strokeWidth:2,dot:!1})})})}),(0,i.jsx)("div",{className:"ag-theme-alpine",style:{height:260},children:(0,i.jsx)(o.s,{rowData:u,columnDefs:E,headerHeight:28,rowHeight:28})})]},t)})})]},t)})})]})}},26634:function(e,t,n){"use strict";n.d(t,{N:function(){return s}});var i=n(8439),a=n(40257);let r=null;function s(){if(r)return r;let e=a.env.NEXT_PUBLIC_SUPABASE_URL,t=a.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;return e&&t?r=(0,i.eI)(e,t):null}}},function(e){e.O(0,[292,884,314,337,505,546,439,666,553,156,971,117,744],function(){return e(e.s=44694)}),_N_E=e.O()}]);